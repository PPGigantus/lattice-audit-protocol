apiVersion: apps/v1
kind: Deployment
metadata:
  name: lap-tool
  namespace: lap-system
  labels:
    app.kubernetes.io/name: lap-tool
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: lap-tool
  template:
    metadata:
      labels:
        app.kubernetes.io/name: lap-tool
    spec:
      containers:
        - name: tool
          image: python:3.11-slim
          imagePullPolicy: IfNotPresent
          env:
            - name: TOOL_PORT
              value: "9000"
          ports:
            - containerPort: 9000
          command: ["python", "-c"]
          args:
            - |
              import os, json
              from http.server import BaseHTTPRequestHandler, HTTPServer
              class H(BaseHTTPRequestHandler):
                def do_POST(self):
                  if self.path != "/invoke":
                    self.send_response(404); self.end_headers(); return
                  raw = self.rfile.read(int(self.headers.get("Content-Length","0") or "0") or 0) or b"{}"
                  try: data = json.loads(raw.decode("utf-8"))
                  except: self.send_response(400); self.end_headers(); return
                  body = json.dumps({"ok": True, "received": data}).encode("utf-8")
                  self.send_response(200)
                  self.send_header("Content-Type","application/json")
                  self.send_header("Content-Length", str(len(body)))
                  self.end_headers()
                  self.wfile.write(body)
                def log_message(self, *args):
                  return
              HTTPServer(("0.0.0.0", int(os.getenv("TOOL_PORT","9000"))), H).serve_forever()
